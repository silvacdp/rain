---
// src/pages/events.astro
// Main events listing page with filtering, sorting, and pagination
// Shows all events in a grid layout with client-side filtering for speed

// Import the main Layout component for consistent site structure
import Layout from '../layouts/Layout.astro';
// Import the reusable EventCard component
import EventCard from '../layouts/EventCard.astro';
// Import the function to fetch events from Airtable
import { getEvents } from '../lib/getEvents.ts';

// Fetch ALL events from Airtable - we'll handle filtering client-side for speed
// Sort by creation date (newest first) as the default
const allEvents = await getEvents({
  sortField: 'Created',
  sortDirection: 'desc',
  // Don't set maxRecords - we want all events for client-side filtering
});

// Extract unique categories from all events for the filter dropdown
// This ensures the filter only shows categories that actually exist in your data
const uniqueCategories = [...new Set(allEvents.map(event => event.category).filter(Boolean))];
---

<!-- Use the main Layout component with a descriptive title -->
<Layout title="All Events - More Rain">
  
  <!-- Main container using the same centered layout as your other pages -->
  <div class="page-container">
    
    <!-- Page header -->
    <section class="page-header">
      <h1 class="page-title">All Events</h1>
      <p class="page-description">
        Browse all documented climate events. Use the filters below to find specific types of events or time periods.
      </p>
    </section>
    
    <!-- Filter and sort controls -->
    <section class="filter-section">
      <div class="filter-controls">
        
        <!-- Sort dropdown -->
        <div class="filter-group">
          <label for="sort-select" class="filter-label">Sort by:</label>
          <select id="sort-select" class="filter-select">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="a-z">A-Z</option>
            <option value="z-a">Z-A</option>
          </select>
        </div>
        
        <!-- Category filter -->
        <div class="filter-group">
          <label for="category-select" class="filter-label">Category:</label>
          <select id="category-select" class="filter-select">
            <option value="">All Categories</option>
            {/* Generate options for each unique category */}
            {uniqueCategories.map(category => (
              <option value={category}>{category}</option>
            ))}
          </select>
        </div>
        
        <!-- Clear filters button -->
        <button id="clear-filters" class="clear-button">Clear Filters</button>
        
      </div>
      
      <!-- Results counter -->
      <div class="results-info">
        <span id="results-count">Showing {allEvents.length} events</span>
      </div>
    </section>
    
    <!-- Events grid container -->
    <section class="events-section">
      <div id="events-grid" class="events-grid">
        {/* We'll populate this with JavaScript, but include all events for non-JS users */}
        {allEvents.map(event => (
          <EventCard event={event} showFullSummary={false} />
        ))}
      </div>
      
      <!-- Loading message (shown during filtering) -->
      <div id="loading-message" class="loading-message" style="display: none;">
        <p>Filtering events...</p>
      </div>
      
      <!-- No results message (shown when no events match filters) -->
      <div id="no-results" class="no-results" style="display: none;">
        <p>No events match your current filters.</p>
        <button id="reset-filters" class="reset-button">Reset Filters</button>
      </div>
    </section>
    
    <!-- Pagination controls -->
    <section class="pagination-section">
      <div id="pagination-info" class="pagination-info">
        <span id="page-info">Page 1 of 1</span>
      </div>
      
      <div id="pagination-controls" class="pagination-controls">
        <button id="prev-page" class="pagination-button" disabled>← Previous</button>
        <div id="page-numbers" class="page-numbers">
          <!-- Page numbers will be generated by JavaScript -->
        </div>
        <button id="next-page" class="pagination-button" disabled>Next →</button>
      </div>
    </section>
    
  </div>
</Layout>

<style>
  /* Main page container using the same pattern as your other pages */
  .page-container {
    max-width: 1200px; /* Wider than EventLayout to accommodate filters and grid */
    margin: 0 auto; /* Centers the container horizontally */
    padding: 0 1rem 2rem; /* Top: 0, sides: 1rem, bottom: 2rem */
    color: var(--white); /* White text using your color variable */
  }
  
  /* Page header styling */
  .page-header {
    margin-bottom: 2rem; /* Space below header */
    text-align: center; /* Center-align the header content */
  }
  
  /* Main page title */
  .page-title {
    font-size: 2.5rem; /* Large, prominent title */
    font-weight: 700; /* Bold */
    color: var(--white); /* White text */
    margin-bottom: 1rem; /* Space below title */
    line-height: 1.2; /* Tight line height */
  }
  
  /* Page description text */
  .page-description {
    font-size: 1.1rem; /* Slightly larger than body text */
    line-height: 1.6; /* Good readability */
    color: var(--platinum); /* Light gray for less prominence than title */
    max-width: 600px; /* Limit line length for better readability */
    margin: 0 auto; /* Center the description */
  }
  
  /* Filter section styling */
  .filter-section {
    margin-bottom: 2rem; /* Space below filters */
    padding: 1.5rem; /* Internal padding */
    background-color: rgba(var(--whitergb), 0.05); /* Subtle background */
    border-radius: 8px; /* Rounded corners */
    border: 1px solid rgba(var(--whitergb), 0.1); /* Subtle border */
  }
  
  /* Filter controls container */
  .filter-controls {
    display: flex;
    flex-wrap: wrap; /* Allow wrapping on smaller screens */
    gap: 1.5rem; /* Space between filter groups */
    align-items: flex-end; /* Align items to bottom for consistent button alignment */
    margin-bottom: 1rem; /* Space below controls */
  }
  
  /* Individual filter group styling */
  .filter-group {
    display: flex;
    flex-direction: column; /* Stack label above select */
    min-width: 150px; /* Minimum width for consistency */
  }
  
  /* Filter labels */
  .filter-label {
    font-size: 0.9rem; /* Smaller than body text */
    font-weight: 500; /* Medium weight */
    color: var(--platinum); /* Light gray */
    margin-bottom: 0.5rem; /* Space below label */
  }
  
  /* Filter select dropdowns */
  .filter-select {
    padding: 0.5rem 0.75rem; /* Generous padding */
    background-color: rgba(var(--whitergb), 0.1); /* Subtle background */
    border: 1px solid rgba(var(--whitergb), 0.2); /* Subtle border */
    border-radius: 4px; /* Rounded corners */
    color: var(--white); /* White text */
    font-size: 0.9rem; /* Consistent font size */
    cursor: pointer; /* Pointer cursor */
    transition: all 0.2s ease; /* Smooth transitions */
  }
  
  /* Select dropdown focus/hover states */
  .filter-select:focus,
  .filter-select:hover {
    border-color: var(--orange); /* Orange border on focus */
    outline: none; /* Remove default outline */
    background-color: rgba(var(--whitergb), 0.15); /* Slightly lighter background */
  }
  
  /* Clear filters button */
  .clear-button {
    padding: 0.5rem 1rem; /* Generous padding */
    background-color: transparent; /* Transparent background */
    border: 1px solid rgba(var(--whitergb), 0.3); /* Subtle border */
    border-radius: 4px; /* Rounded corners */
    color: var(--platinum); /* Light gray text */
    font-size: 0.9rem; /* Consistent font size */
    cursor: pointer; /* Pointer cursor */
    transition: all 0.2s ease; /* Smooth transitions */
  }
  
  /* Clear button hover state */
  .clear-button:hover {
    background-color: rgba(var(--whitergb), 0.1); /* Subtle background */
    border-color: var(--white); /* White border */
    color: var(--white); /* White text */
  }
  
  /* Results info styling */
  .results-info {
    text-align: center; /* Center the results counter */
    color: var(--platinum); /* Light gray */
    font-size: 0.9rem; /* Smaller text */
  }
  
  /* Events section */
  .events-section {
    margin-bottom: 2rem; /* Space below events */
    min-height: 400px; /* Minimum height to prevent layout jumping */
  }
  
  /* Events grid layout - same as your home page */
  .events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive grid */
    gap: 2rem; /* Space between cards */
    margin-bottom: 2rem; /* Space below grid */
  }
  
  /* Loading message styling */
  .loading-message {
    text-align: center;
    padding: 2rem;
    color: var(--platinum); /* Light gray */
    font-style: italic;
  }
  
  /* No results message styling */
  .no-results {
    text-align: center;
    padding: 2rem;
    background-color: rgba(var(--whitergb), 0.05); /* Subtle background */
    border-radius: 8px;
    border: 1px solid rgba(var(--whitergb), 0.1); /* Subtle border */
  }
  
  /* Reset filters button */
  .reset-button {
    margin-top: 1rem; /* Space above button */
    padding: 0.75rem 1.5rem; /* Generous padding */
    background-color: var(--orange); /* Orange background */
    border: none; /* No border */
    border-radius: 4px; /* Rounded corners */
    color: var(--blue); /* Blue text for contrast */
    font-weight: 500; /* Medium weight */
    cursor: pointer; /* Pointer cursor */
    transition: all 0.2s ease; /* Smooth transitions */
  }
  
  /* Reset button hover state */
  .reset-button:hover {
    background-color: var(--white); /* White background */
    transform: translateY(-1px); /* Slight lift effect */
  }
  
  /* Pagination section */
  .pagination-section {
    display: flex;
    justify-content: space-between; /* Space between info and controls */
    align-items: center; /* Center vertically */
    flex-wrap: wrap; /* Allow wrapping on smaller screens */
    gap: 1rem; /* Space between elements */
    padding: 1rem 0; /* Vertical padding */
    border-top: 1px solid rgba(var(--whitergb), 0.2); /* Subtle top border */
  }
  
  /* Pagination info styling */
  .pagination-info {
    color: var(--platinum); /* Light gray */
    font-size: 0.9rem; /* Smaller text */
  }
  
  /* Pagination controls container */
  .pagination-controls {
    display: flex;
    align-items: center; /* Center vertically */
    gap: 0.5rem; /* Space between elements */
  }
  
  /* Pagination buttons */
  .pagination-button {
    padding: 0.5rem 1rem; /* Generous padding */
    background-color: rgba(var(--whitergb), 0.1); /* Subtle background */
    border: 1px solid rgba(var(--whitergb), 0.2); /* Subtle border */
    border-radius: 4px; /* Rounded corners */
    color: var(--white); /* White text */
    font-size: 0.9rem; /* Consistent font size */
    cursor: pointer; /* Pointer cursor */
    transition: all 0.2s ease; /* Smooth transitions */
  }
  
  /* Pagination button hover state */
  .pagination-button:hover:not(:disabled) {
    background-color: var(--orange); /* Orange background */
    border-color: var(--orange); /* Orange border */
    color: var(--blue); /* Blue text for contrast */
  }
  
  /* Disabled pagination button */
  .pagination-button:disabled {
    opacity: 0.5; /* Reduced opacity */
    cursor: not-allowed; /* Not-allowed cursor */
  }
  
  /* Page numbers container */
  .page-numbers {
    display: flex;
    gap: 0.25rem; /* Small space between page numbers */
  }
  
  /* Individual page number buttons */
  .page-number {
    padding: 0.5rem 0.75rem; /* Generous padding */
    background-color: rgba(var(--whitergb), 0.1); /* Subtle background */
    border: 1px solid rgba(var(--whitergb), 0.2); /* Subtle border */
    border-radius: 4px; /* Rounded corners */
    color: var(--white); /* White text */
    font-size: 0.9rem; /* Consistent font size */
    cursor: pointer; /* Pointer cursor */
    transition: all 0.2s ease; /* Smooth transitions */
    text-decoration: none; /* Remove link underline */
    display: inline-block; /* Inline block for consistent sizing */
  }
  
  /* Page number hover state */
  .page-number:hover {
    background-color: rgba(var(--whitergb), 0.2); /* Lighter background */
    border-color: var(--white); /* White border */
  }
  
  /* Active page number */
  .page-number.active {
    background-color: var(--orange); /* Orange background */
    border-color: var(--orange); /* Orange border */
    color: var(--blue); /* Blue text for contrast */
  }
  
  /* Responsive design for smaller screens */
  @media (max-width: 768px) {
    .page-container {
      max-width: 100%; /* Full width on mobile */
    }
    
    .page-title {
      font-size: 2rem; /* Smaller title on mobile */
    }
    
    .page-description {
      font-size: 1rem; /* Standard size on mobile */
    }
    
    .filter-controls {
      flex-direction: column; /* Stack filters vertically on mobile */
      align-items: stretch; /* Stretch to full width */
    }
    
    .filter-group {
      min-width: auto; /* Remove minimum width on mobile */
    }
    
    .events-grid {
      grid-template-columns: 1fr; /* Single column on mobile */
      gap: 1.5rem; /* Less gap on mobile */
    }
    
    .pagination-section {
      flex-direction: column; /* Stack pagination vertically on mobile */
      text-align: center; /* Center align */
    }
    
    .pagination-controls {
      flex-wrap: wrap; /* Allow wrapping on mobile */
      justify-content: center; /* Center the controls */
    }
  }
</style>

<script>
  // Client-side JavaScript for filtering, sorting, and pagination
  // This runs after the page loads and provides interactive functionality
  
  // Get all the events data from the server-rendered HTML
  // We'll extract this from the DOM to avoid duplicating data
  const allEventsData = {allEvents};
  
  // Configuration for pagination
  const EVENTS_PER_PAGE = 12; // Number of events to show per page
  
  // Global state for filtering and pagination
  let currentPage = 1;
  let filteredEvents = [...allEventsData]; // Start with all events
  let currentFilters = {
    sort: 'newest',
    category: ''
  };
  
  // Category colors for placeholder images
  const categoryColors = {
    'Rain/Flood': '#3B82F6', // Blue
    'Heatwave': '#F97316', // Orange
    'Wildfire': '#EF4444', // Red
    'Other': '#6B7280' // Gray
  };
  
  // Function to get category icon (same as EventCard.astro)
  function getCategoryIcon(category) {
    switch (category) {
      case 'Rain/Flood':
        return '🌧️';
      case 'Heatwave':
        return '🌡️';
      case 'Wildfire':
        return '🔥';
      case 'Other':
        return '⚠️';
      default:
        return '🌍';
    }
  }
  
  // Function to format date ranges (same as EventCard.astro)
  function formatDateRange(startDate, endDate) {
    if (!startDate) return '';
    
    const start = new Date(startDate);
    const startOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    
    if (!endDate) {
      return start.toLocaleDateString('en-US', startOptions);
    }
    
    const end = new Date(endDate);
    
    if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
      return `${start.toLocaleDateString('en-US', { month: 'long' })} ${start.getDate()}-${end.getDate()}, ${start.getFullYear()}`;
    }
    
    if (start.getFullYear() === end.getFullYear()) {
      return `${start.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}, ${start.getFullYear()}`;
    }
    
    return `${start.toLocaleDateString('en-US', startOptions)} - ${end.toLocaleDateString('en-US', startOptions)}`;
  }
  
  // Function to truncate text for card summaries
  function truncateText(text, maxLength = 150) {
    if (!text || text.length <= maxLength) return text;
    return text.substring(0, maxLength).trim() + '...';
  }
  
  // Function to create a placeholder image for events without images
  function createPlaceholderImage(category) {
    const color = categoryColors[category] || categoryColors['Other'];
    const icon = getCategoryIcon(category);
    
    return `
      <div class="placeholder-image" style="background-color: ${color}; width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; font-size: 3rem;">
        ${icon}
      </div>
    `;
  }
  
  // Function to create HTML for a single event card
  function createEventCardHTML(event) {
    const formattedDate = formatDateRange(event.startDate, event.endDate);
    const displaySummary = truncateText(event.summary);
    
    return `
      <article class="event-card">
        <a href="/events/${event.slug}" class="card-link">
          <div class="card-image">
            ${event.imageUrl ? 
              `<img src="${event.imageUrl}" alt="${event.title}" loading="lazy" />` : 
              createPlaceholderImage(event.category)
            }
          </div>
          <div class="card-content">
            <h3 class="card-title">${event.title}</h3>
            <div class="card-meta">
              ${formattedDate ? `<span class="card-date">📅 ${formattedDate}</span>` : ''}
              ${event.location ? `<span class="card-location">🌍 ${event.location}</span>` : ''}
              ${event.category ? `<span class="card-category">${getCategoryIcon(event.category)} ${event.category}</span>` : ''}
            </div>
            ${event.quote ? `<blockquote class="card-quote">"${event.quote}"</blockquote>` : ''}
            ${displaySummary ? `<p class="card-summary">${displaySummary}</p>` : ''}
          </div>
        </a>
      </article>
    `;
  }
  
  // Function to sort events based on selected option
  function sortEvents(events, sortOption) {
    const sortedEvents = [...events];
    
    switch (sortOption) {
      case 'newest':
        return sortedEvents.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
      case 'oldest':
        return sortedEvents.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
      case 'a-z':
        return sortedEvents.sort((a, b) => a.title.localeCompare(b.title));
      case 'z-a':
        return sortedEvents.sort((a, b) => b.title.localeCompare(a.title));
      default:
        return sortedEvents;
    }
  }
  
  // Function to filter events based on selected criteria
  function filterEvents() {
    let filtered = [...allEventsData];
    
    // Apply category filter if selected
    if (currentFilters.category) {
      filtered = filtered.filter(event => event.category === currentFilters.category);
    }
    
    // Apply sorting
    filtered = sortEvents(filtered, currentFilters.sort);
    
    return filtered;
  }
  
  // Function to update the events display
  function updateEventsDisplay() {
    // Show loading message
    document.getElementById('loading-message').style.display = 'block';
    document.getElementById('events-grid').style.display = 'none';
    document.getElementById('no-results').style.display = 'none';
    
    // Small delay to show loading state
    setTimeout(() => {
      // Filter and sort events
      filteredEvents = filterEvents();
      
      // Update results counter
      const resultsCount = document.getElementById('results-count');
      resultsCount.textContent = `Showing ${filteredEvents.length} events`;
      
      // Check if we have any results
      if (filteredEvents.length === 0) {
        document.getElementById('loading-message').style.display = 'none';
        document.getElementById('events-grid').style.display = 'none';
        document.getElementById('no-results').style.display = 'block';
        updatePagination();
        return;
      }
      
      // Reset to first page when filters change
      currentPage = 1;
      
      // Update the display
      displayCurrentPage();
      updatePagination();
      
      // Hide loading message and show results
      document.getElementById('loading-message').style.display = 'none';
      document.getElementById('events-grid').style.display = 'grid';
      document.getElementById('no-results').style.display = 'none';
    }, 100);
  }
  
  // Function to display events for the current page
  function displayCurrentPage() {
    const startIndex = (currentPage - 1) * EVENTS_PER_PAGE;
    const endIndex = startIndex + EVENTS_PER_PAGE;
    const pageEvents = filteredEvents.slice(startIndex, endIndex);
    
    // Generate HTML for current page events
    const eventsHTML = pageEvents.map(event => createEventCardHTML(event)).join('');
    
    // Update the events grid
    document.getElementById('events-grid').innerHTML = eventsHTML;
    
    // Scroll to top of events section
    document.querySelector('.events-section').scrollIntoView({ behavior: 'smooth' });
  }
  
  // Function to update pagination controls
  function updatePagination() {
    const totalPages = Math.ceil(filteredEvents.length / EVENTS_PER_PAGE);
    
    // Update page info
    document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
    
    // Update previous/next buttons
    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
    
    // Generate page numbers
    const pageNumbers = document.getElementById('page-numbers');
    pageNumbers.innerHTML = '';
    
    // Show page numbers (limit to 5 for mobile friendliness)
    const maxPageNumbers = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxPageNumbers / 2));
    let endPage = Math.min(totalPages, startPage + maxPageNumbers - 1);
    
    // Adjust start page if we're near the end
    if (endPage - startPage + 1 < maxPageNumbers) {
      startPage = Math.max(1, endPage - maxPageNumbers + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
      const pageButton = document.createElement('button');
      pageButton.textContent = i;
      pageButton.className = `page-number ${i === currentPage ? 'active' : ''}`;
      pageButton.addEventListener('click', () => {
        currentPage = i;
        displayCurrentPage();
        updatePagination();
      });
      pageNumbers.appendChild(pageButton);
    }
  }
  
  // Initialize the page when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    // Get filter elements
    const sortSelect = document.getElementById('sort-select');
    const categorySelect = document.getElementById('category-select');
    const clearButton = document.getElementById('clear-filters');
    const resetButton = document.getElementById('reset-filters');
    
    // Get pagination elements
    const prevButton = document.getElementById('prev-page');
    const nextButton = document.getElementById('next-page');
    
    // Set up event listeners for filters
    sortSelect.addEventListener('change', (e) => {
      currentFilters.sort = e.target.value;
      updateEventsDisplay();
    });
    
    categorySelect.addEventListener('change', (e) => {
      currentFilters.category = e.target.value;
      updateEventsDisplay();
    });
    
    // Clear filters button
    clearButton.addEventListener('click', () => {
      sortSelect.value = 'newest';
      categorySelect.value = '';
      currentFilters = { sort: 'newest', category: '' };
      updateEventsDisplay();
    });
    
    // Reset filters button (in no-results section)
    resetButton.addEventListener('click', () => {
      sortSelect.value = 'newest';
      categorySelect.value = '';
      currentFilters = { sort: 'newest', category: '' };
      updateEventsDisplay();
    });
    
    // Set up pagination event listeners
    prevButton.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        displayCurrentPage();
        updatePagination();
      }
    });
    
    nextButton.addEventListener('click', () => {
      const totalPages = Math.ceil(filteredEvents.length / EVENTS_PER_PAGE);
      if (currentPage < totalPages) {
        currentPage++;
        displayCurrentPage();
        updatePagination();
      }
    });
    
    // Initialize the display
    updateEventsDisplay();
  });
</script>
